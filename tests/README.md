# E2E测试文档

## 概述
本目录包含AI语音克隆网站的端到端(E2E)测试，覆盖声音克隆、积分扣除、声音库和语音生成的完整流程。

## 测试环境
- **前端**: http://localhost:3000 (Vite + React)
- **后端**: http://localhost:8080 (Go + Gin)
- **测试框架**: Playwright (TypeScript)
- **测试用户**: xiaowu.417@qq.com / 1234qwer

## 测试文件

| 脚本文件 | 说明 | 执行时间 |
|---------|------|---------|
| `e2e/credit_system.spec.ts` | 积分系统E2E (Test 10-12) | ~2-4分钟 |
| `e2e/voice_clone.spec.ts` | 声音克隆与声音库 | ~1-3分钟 |
| `e2e/test6-simple.spec.ts` | 预定义音色展示 | ~10-20秒 |
| `delete_user_account.py` | 清理用户/文件/音色(含OSS) | ~10-20秒 |

其他文件：
- `playwright.config.ts` - Playwright配置

## 如何运行测试

### 方式1: 完整测试(推荐)
```bash
# 启动服务
./run_frontend_and_backend.sh start

# 运行完整E2E
npx playwright test

# 清理测试数据
python3 tests/cleanup_via_api.py

# 停止服务
./run_frontend_and_backend.sh stop
```

### 仅清理测试数据
```bash
python3 tests/delete_user_account.py <email> <password>
```

## 测试场景

### Test 10-12: 积分系统与无限积分账号
**目标**: 验证注册积分、生成扣费、余额不足提示、无限积分账号规则

**步骤**:
1. 用户登录系统
2. 上传`1229.MP3`文件进行声音克隆
3. 系统扣除相应积分并创建音色
4. 刷新页面后，确认音色和上传文件列表都正确显示
5. 使用已上传的文件再次克隆，创建新音色
6. 删除上传的音频文件
7. 验证文件列表中不再显示该文件，但音色仍然保留

**验证点**:
- ✅ 文件上传成功
- ✅ 音色创建成功
- ✅ 已上传文件列表显示文件名和上传时间
- ✅ 文件重用功能正常
- ✅ 文件删除功能正常
- ✅ 删除文件后音色不受影响

### Test 1-6: 声音克隆与声音库流程
**目标**: 验证音色创建、预定义音色使用、声音库展示与操作

**步骤**:
1. 用户登出并重新登录
2. 上传`1230.MP3`文件进行声音克隆
3. 不刷新页面，验证音色和文件列表实时更新

**验证点**:
- ✅ 重新登录功能正常
- ✅ 上传后实时显示音色(无需刷新)
- ✅ 上传后实时显示文件列表(无需刷新)

### Test 6: 预定义音色展示
**目标**: 验证预定义音色列表和展示状态

**步骤**:
1. 导航到"声音库"页面
2. 删除指定音色
3. 系统调用Fish Audio的DELETE API
4. 验证音色从列表中消失

**验证点**:
- ✅ 声音库页面正常显示
- ✅ 删除按钮功能正常
- ✅ 后端调用Fish Audio删除API
- ✅ 音色从列表中移除

**API调用**: `DELETE https://api.fish.audio/model/{id}`

### Test 4: 声音库与语音合成
**目标**: 验证声音库应用与TTS生成流程

**步骤**:
1. 等待音色训练完成(最多5分钟)
2. 导航到"声音库"页面
3. 选择音色并点击"应用音色"
4. 系统跳转回工作台，确认音色已选择
5. 输入带情感标签的文本: "你好，这是一个测试。(高兴)"
6. 点击生成语音
7. 验证发送到后端的文本正确转换为: "你好，这是一个测试。(happy)"
8. 等待语音生成完成
9. 删除生成历史记录

**验证点**:
- ✅ 音色训练完成检测
- ✅ 声音库显示用户音色
- ✅ 应用音色功能正常
- ✅ 工作台显示已选择的音色
- ✅ 情感标签正确转换(高兴 -> happy)
- ✅ TTS API调用成功
- ✅ 语音生成并显示下载按钮
- ✅ 生成历史删除功能正常

## 实现的功能

### 后端
1. **TTS积分计费** - 按UTF-8字节数计费，5000字节上限
2. **TTS支持预定义音色** - 允许预定义音色ID
3. **积分规则** - 语音生成扣费，音色创建免费
4. **预定义音色列表** - 内置8个音色信息

### 前端
1. **积分显示与刷新** - 生成后刷新余额
2. **文本字节数限制** - 前端先行校验5000字节
3. **余额不足提示** - 显示充值入口按钮

### Test 5: UI界面验证
**目标**: 验证界面元素的正确性和导航功能

**步骤**:
1. 运行Test 1创建测试数据
2. 导航到"声音库"，确认所有音色块都没有"试听样品"按钮
3. 导航到"声音克隆"，点击已上传的文件，确认没有"重命名"按钮
4. 在"声音库"页面点击"克隆新声音"，确认跳转到声音克隆界面

**验证点**:
- ✅ 声音库中无"试听样品"按钮
- ✅ 文件重用对话框无"重命名"按钮
- ✅ "克隆新声音"按钮正确导航

## 测试清理

**说明**: 可使用清理脚本删除用户及其OSS资源。

**手动清理命令**:
```bash
python3 tests/delete_user_account.py <email> <password>
```

## 测试结果

**状态**: ✅ E2E测试通过

**执行时间**: 
- 完整测试: 5-10分钟(含训练等待)
- 快速测试: 30秒(跳过训练)

**测试覆盖**:
- 用户认证和登录
- 声音克隆与预定义音色使用
- 积分扣费、余额不足与无限积分
- TTS语音合成与长度校验
- 声音库展示与操作

## 已知问题和注意事项

1. **UI更新延迟**: 删除操作的UI更新可能有1-3秒延迟，这是由于React状态更新和后端API响应的异步性质
2. **训练时间**: Fish Audio音色训练通常需要20-40秒
3. **多次运行**: 多次运行测试会产生重复的文件记录，建议定期清理数据库
4. **Dialog处理**: 所有确认对话框会自动接受

## 未来改进

1. 添加测试前的数据库清理步骤
2. 添加API错误情况的测试
3. 添加网络异常的重试机制测试
4. 添加并发上传的压力测试
5. 添加文件大小限制的边界测试
