# E2E测试文档

## 概述
本目录包含了AI语音克隆网站的端到端(E2E)测试，遵循TDD原则编写。测试覆盖了声音克隆、文件管理、声音库和语音生成的完整流程。

## 测试环境
- **前端**: http://localhost:3000 (Vite + React)
- **后端**: http://localhost:8080 (Go + Gin)
- **测试框架**: Playwright (Python)
- **测试用户**: xiaowu.417@qq.com / 1234qwer

## 测试文件

| 脚本文件 | 说明 | 执行时间 |
|---------|------|---------|
| `run_e2e_tests.py` | 完整测试套件(Test 1-5) | ~5-10分钟 |
| `cleanup_via_api.py` | API清理测试数据 | ~10秒 |
| `cleanup_test_data.py` | UI清理测试数据(备用) | ~1-2分钟 |
| `run_all_tests_with_cleanup.sh` | 测试+自动清理 | ~5-10分钟 |

其他文件：
- `playwright.config.ts` - Playwright配置(TypeScript版本)
- `e2e/voice_clone.spec.ts` - TypeScript测试规格(备用)

## 如何运行测试

### 方式1: 完整测试(推荐)
```bash
# 启动服务
./run_frontend_and_backend.sh start

# 运行完整测试(包含Test 1-5)
python3 tests/run_e2e_tests.py

# 清理测试数据
python3 tests/cleanup_via_api.py

# 停止服务
./run_frontend_and_backend.sh stop
```

### 方式2: 一键运行(自动清理)
```bash
./tests/run_all_tests_with_cleanup.sh
```

### 仅清理测试数据
```bash
python3 tests/cleanup_via_api.py
```

## 测试场景

### Test 1: 声音克隆、文件上传和管理
**目标**: 验证用户可以上传音频、克隆声音、重用已上传文件、并删除文件

**步骤**:
1. 用户登录系统
2. 上传`1229.MP3`文件进行声音克隆
3. 系统扣除相应积分并创建音色
4. 刷新页面后，确认音色和上传文件列表都正确显示
5. 使用已上传的文件再次克隆，创建新音色
6. 删除上传的音频文件
7. 验证文件列表中不再显示该文件，但音色仍然保留

**验证点**:
- ✅ 文件上传成功
- ✅ 音色创建成功
- ✅ 已上传文件列表显示文件名和上传时间
- ✅ 文件重用功能正常
- ✅ 文件删除功能正常
- ✅ 删除文件后音色不受影响

### Test 2: 重新登录和实时更新
**目标**: 验证用户重新登录后的功能和实时UI更新

**步骤**:
1. 用户登出并重新登录
2. 上传`1230.MP3`文件进行声音克隆
3. 不刷新页面，验证音色和文件列表实时更新

**验证点**:
- ✅ 重新登录功能正常
- ✅ 上传后实时显示音色(无需刷新)
- ✅ 上传后实时显示文件列表(无需刷新)

### Test 3: 通过API删除音色
**目标**: 验证音色删除功能，包括Fish Audio平台的同步删除

**步骤**:
1. 导航到"声音库"页面
2. 删除指定音色
3. 系统调用Fish Audio的DELETE API
4. 验证音色从列表中消失

**验证点**:
- ✅ 声音库页面正常显示
- ✅ 删除按钮功能正常
- ✅ 后端调用Fish Audio删除API
- ✅ 音色从列表中移除

**API调用**: `DELETE https://api.fish.audio/model/{id}`

### Test 4: 声音库和语音合成(含情感标签)
**目标**: 验证声音库应用、情感标签转换和TTS生成完整流程

**步骤**:
1. 等待音色训练完成(最多5分钟)
2. 导航到"声音库"页面
3. 选择音色并点击"应用音色"
4. 系统跳转回工作台，确认音色已选择
5. 输入带情感标签的文本: "你好，这是一个测试。(高兴)"
6. 点击生成语音
7. 验证发送到后端的文本正确转换为: "你好，这是一个测试。(happy)"
8. 等待语音生成完成
9. 删除生成历史记录

**验证点**:
- ✅ 音色训练完成检测
- ✅ 声音库显示用户音色
- ✅ 应用音色功能正常
- ✅ 工作台显示已选择的音色
- ✅ 情感标签正确转换(高兴 -> happy)
- ✅ TTS API调用成功
- ✅ 语音生成并显示下载按钮
- ✅ 生成历史删除功能正常

## 实现的功能

### 后端
1. **UploadedFile模型** - 追踪用户上传的音频文件
2. **GET /api/v1/upload/audio** - 获取已上传文件列表
3. **DELETE /api/v1/upload/audio/:id** - 删除已上传文件(同步删除OSS)
4. **DeleteVoice服务** - 调用Fish Audio API删除音色
5. **情感标签映射** - 将中文情感标签转换为英文

### 前端
1. **已上传文件列表** - 在VoiceCloningSection显示历史上传
2. **文件重用功能** - 点击已上传文件可重新使用
3. **文件删除功能** - 删除已上传文件及OSS存储
4. **声音库应用** - 从声音库选择音色并应用到工作台
5. **情感标签转换** - 支持"高兴"等中文标签自动转换
6. **实时UI更新** - 上传、克隆、生成后自动刷新列表

### Test 5: UI界面验证
**目标**: 验证界面元素的正确性和导航功能

**步骤**:
1. 运行Test 1创建测试数据
2. 导航到"声音库"，确认所有音色块都没有"试听样品"按钮
3. 导航到"声音克隆"，点击已上传的文件，确认没有"重命名"按钮
4. 在"声音库"页面点击"克隆新声音"，确认跳转到声音克隆界面

**验证点**:
- ✅ 声音库中无"试听样品"按钮
- ✅ 文件重用对话框无"重命名"按钮
- ✅ "克隆新声音"按钮正确导航

## 测试清理

**重要**: 所有测试运行完后，会自动清理产生的数据：
- 上传的音频文件(数据库+OSS)
- 生成的音色(数据库+Fish Audio平台)
- 生成的TTS音频(数据库+OSS)
- 测试日志文件

**手动清理命令**:
```bash
python3 tests/cleanup_via_api.py
```

## 测试结果

**状态**: ✅ 所有测试通过(Test 1-5)

**执行时间**: 
- 完整测试: 5-10分钟(含训练等待)
- 快速测试: 30秒(跳过训练)

**测试覆盖**:
- 用户认证和登录
- 音频文件上传和OSS存储
- 声音克隆和Fish Audio集成
- 文件列表查询和删除
- 文件重用功能
- 声音库管理
- 音色删除(Fish Audio同步)
- TTS语音合成
- 情感标签处理
- 生成历史管理
- UI界面元素验证

## 已知问题和注意事项

1. **UI更新延迟**: 删除操作的UI更新可能有1-3秒延迟，这是由于React状态更新和后端API响应的异步性质
2. **训练时间**: Fish Audio音色训练通常需要20-40秒
3. **多次运行**: 多次运行测试会产生重复的文件记录，建议定期清理数据库
4. **Dialog处理**: 所有确认对话框会自动接受

## 未来改进

1. 添加测试前的数据库清理步骤
2. 添加API错误情况的测试
3. 添加网络异常的重试机制测试
4. 添加并发上传的压力测试
5. 添加文件大小限制的边界测试
